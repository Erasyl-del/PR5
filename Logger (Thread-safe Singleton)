import java.io.*;
import java.text.SimpleDateFormat;
import java.util.Date;

public class Logger {

    private static volatile Logger instance;
    private static final Object lock = new Object();

    private LogLevel currentLevel = LogLevel.INFO;
    private String logFilePath = "app.log";
    private long maxFileSize = 1024 * 50; // rotation
    private final Object writeLock = new Object();

    //  private constructor
    private Logger() {}

    //  thread-safe
    public static Logger getInstance() {
        if (instance == null) {
            synchronized (Logger.class) {
                if (instance == null) {
                    instance = new Logger();
                }
            }
        }
        return instance;
    }

    // ---------------- CONFIG ----------------

    public void loadConfig(String path) {
        LoggerConfig cfg = new LoggerConfig();

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String line;
            while ((line = br.readLine()) != null) {
                String[] p = line.split("=");
                if (p.length != 2) continue;

                switch (p[0].trim()) {
                    case "level":
                        cfg.level = LogLevel.valueOf(p[1].trim());
                        break;
                    case "file":
                        cfg.logFilePath = p[1].trim();
                        break;
                }
            }
        } catch (Exception e) {
            System.out.println("Config load error: " + e.getMessage());
        }

        this.currentLevel = cfg.level;
        this.logFilePath = cfg.logFilePath;
    }

    public void setLogLevel(LogLevel level) {
        this.currentLevel = level;
    }

    // ---------------- LOGGING ----------------

    public void log(String message, LogLevel level) {
        if (level.ordinal() < currentLevel.ordinal()) return;

        String time = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        String line = time + " [" + level + "] " + message;

        synchronized (writeLock) {
            rotateIfNeeded();

            try (PrintWriter pw = new PrintWriter(new FileWriter(logFilePath, true))) {
                pw.println(line);
            } catch (IOException e) {
                e.printStackTrace();
            }

            //  console output (extra)
            System.out.println(line);
        }
    }

    // ---------------- ROTATION ----------------

    private void rotateIfNeeded() {
        File file = new File(logFilePath);
        if (file.exists() && file.length() > maxFileSize) {
            File newFile = new File(logFilePath + "." + System.currentTimeMillis());
            file.renameTo(newFile);
        }
    }

    public String getLogFilePath() {
        return logFilePath;
    }
}
